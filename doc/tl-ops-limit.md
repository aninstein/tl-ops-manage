# tl openresty limit-fuse module

### 熔断限流分为两个模块，自检模块，配置同步模块。

## 1. 自检
   服务启动时，重载配置时自动刷新启动，。
   
   一份自检服务配置，会对该服务下的所有节点用同一份配置进行自检，自检配置提供如下字段

```
    {
        service_name = "service2",      #自检服务名称
        interval = 10 * 1000,           #自检周期， 默认单位/ms
        node_threshold = 0.3,           #节点阈值，如果某个节点路由（失败次数/路由总量）占比超过这个阈值，将对节点进行降级
        service_threshold = 0.5,        #服务阈值，如果某个服务下（节点熔断个数/节点总量）占比超过这个阈值，将对服务进行降级
        recover = 3 * 1000,             #单个自检周期内服务熔断后，自动恢复服务的周期。以此实现自动化熔断和限流
        depend = "token",               #限流依赖的策略模式，token:令牌桶限流，leak:漏桶限流（暂不支持）
        level = "service"               #自检层级，默认为服务(service)。包含服务下的所有节点
    }
```
#### 自动化熔断恢复实现思路
    待完善
    


## 2. 配置同步
   服务支持动态新增，为保持动态扩展性，支持自检配置的动态同步。
   包括新增服务自检配置，现有服务配置改动，两种情况下的配置平滑同步，无需reload nginx。
    

#### 配置同步实现思路

    依靠shared:dict共享内存实现，多个worker中依赖一个公共的配置版本号，若有某个worker检测到配置的新增或变动，自增版本号即可。
    
    其他worker自检前，与共享版本号对比自身配置版本号，若存在新增或变动，同步最新配置到worker内即可
    


