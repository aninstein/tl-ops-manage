# tl openresty health-check module

### 健康检查分为两个模块，自检模块，配置同步模块。

# 1. 自检
   服务启动时，重载配置时自动刷新启动，针对默认提供的服务节点配置进行自动心跳检查，目前是http回包自检。
   
   一份自检服务配置，会对该服务下的所有节点用同一份配置进行自检，自检配置提供如下字段

```
    {
        check_failed_max_count = 5,         #自检时心跳包最大失败次数，达到这个次数会将在线节点置为下线。
        check_success_max_count = 2,        #自检时心跳包最大成功次数，达到这个次数会将下线节点置为上线。
        check_interval = 5 * 1000,          #自检周期， 默认单位/ms
        check_timeout = 1000,               #自检心跳包接收超时时间，默认单位/ms
        check_content = "GET / HTTP/1.0",   #自检心跳包内容，可自定义，但是需要被检方处理兼容。
        check_service_name = "service1"     #自检服务名称
    }
```

# 2. 配置同步

   服务支持动态新增，为保持动态扩展性，支持自检配置的动态同步。

   包括新增服务自检配置，现有服务配置改动，两种情况下的配置平滑同步，无需reload nginx。

   暂时支持增量配置，或配置变更的实时同步，后续逐步支持删除配置的实时同步
    

### 配置同步实现思路

    依靠shared:dict共享内存实现，多个worker中依赖一个公共的配置版本号，若有某个worker检测到配置的新增或变动，自增版本号即可。
    
    其他worker自检前，与共享版本号对比自身配置版本号，若存在新增或变动，同步最新配置到worker内即可